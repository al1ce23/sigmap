<!DOCTYPE html>
<html>
<head>
  <title>SIGMAp</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />

  <!-- MarkerCluster CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />

  <!-- Leaflet.heat CSS (no CSS needed, just JS) -->

  <!-- Lightbox CSS -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/lightbox2/2.11.4/css/lightbox.min.css" rel="stylesheet">

  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #1a1a1a;
      color: #e0e0e0;
    }
    #map {
      height: 100vh;
      width: 100%;
    }
    #controls {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      padding: 12px 20px;
      background: rgba(30, 30, 30, 0.95);
      backdrop-filter: blur(10px);
      border-top: 1px solid #3a3a3a;
      box-shadow: 0 -2px 10px rgba(0,0,0,0.5);
      z-index: 1000;
    }
    .controls-inner {
      max-width: 1400px;
      margin: 0 auto;
      display: flex;
      flex-direction: row;
      align-items: center;
      gap: 20px;
    }
    .controls-row {
      display: flex;
      align-items: center;
      gap: 20px;
    }
    .slider-wrapper {
      flex: 1;
      position: relative;
    }
    .slider-container {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 6px;
    }
    .slider-container label {
      min-width: 50px;
      font-weight: 600;
      color: #b0b0b0;
      font-size: 13px;
    }
    .slider-track {
      position: relative;
      flex: 1;
    }
    .slider-container input[type="range"] {
      width: 100%;
      height: 6px;
      -webkit-appearance: none;
      appearance: none;
      background: #3a3a3a;
      outline: none;
      border-radius: 3px;
      cursor: pointer;
    }
    .slider-container input[type="range"]:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }
    .slider-container input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 16px;
      height: 16px;
      background: #f59e0b;
      cursor: pointer;
      border-radius: 50%;
      box-shadow: 0 2px 4px rgba(0,0,0,0.4);
      transition: transform 0.2s;
    }
    .slider-container input[type="range"]::-webkit-slider-thumb:hover {
      transform: scale(1.15);
      background: #fbbf24;
    }
    .slider-container input[type="range"]::-moz-range-thumb {
      width: 16px;
      height: 16px;
      background: #f59e0b;
      cursor: pointer;
      border-radius: 50%;
      border: none;
      box-shadow: 0 2px 4px rgba(0,0,0,0.4);
    }
    .slider-value {
      min-width: 80px;
      font-weight: 600;
      color: #f59e0b;
      text-align: right;
      font-size: 13px;
    }
    .month-markers {
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin-top: 6px;
      font-size: 10px;
      color: #707070;
    }
    .years-row {
      display: flex;
      flex-wrap: nowrap;
      gap: 6px;
      align-items: center;
    }
    .year-marker {
      cursor: pointer;
      padding: 4px 8px;
      border-radius: 4px;
      transition: all 0.2s;
      user-select: none;
      background: #2a2a2a;
      border: 1px solid transparent;
      font-weight: 600;
      font-size: 11px;
      white-space: nowrap;
    }
    .year-marker:hover {
      background: #3a3a3a;
      color: #f59e0b;
      border-color: #f59e0b;
    }
    .year-marker.expanded {
      color: #f59e0b;
      background: #3a2a1a;
      border-color: #f59e0b;
    }
    .months-row {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      margin-left: 8px;
      margin-top: 4px;
    }
    .months-row.hidden {
      display: none;
    }
    .month-marker {
      cursor: pointer;
      padding: 3px 6px;
      border-radius: 4px;
      transition: all 0.2s;
      user-select: none;
      background: #2a2a2a;
      border: 1px solid transparent;
    }
    .month-marker:hover {
      background: #3a3a3a;
      color: #f59e0b;
      border-color: #f59e0b;
    }
    .month-marker.active {
      color: #f59e0b;
      font-weight: bold;
      background: #3a2a1a;
      border-color: #f59e0b;
    }
    .month-marker.selected {
      color: #f59e0b;
      font-weight: bold;
      background: #3a2a1a;
      border-color: #f59e0b;
    }
    .checkbox-container {
      display: flex;
      align-items: center;
      gap: 8px;
      white-space: nowrap;
    }
    .checkbox-container input[type="checkbox"] {
      width: 16px;
      height: 16px;
      cursor: pointer;
      accent-color: #f59e0b;
    }
    .checkbox-container label {
      cursor: pointer;
      color: #b0b0b0;
      font-size: 13px;
    }
    .random-button, .view-toggle-button {
      padding: 8px 16px;
      background: #f59e0b;
      color: #1a1a1a;
      border: none;
      border-radius: 6px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      white-space: nowrap;
    }
    .random-button:hover, .view-toggle-button:hover {
      background: #fbbf24;
      transform: translateY(-1px);
      box-shadow: 0 2px 8px rgba(245, 158, 11, 0.4);
    }
    .random-button:active, .view-toggle-button:active {
      transform: translateY(0);
    }
    .view-toggle-button {
      background: #3a3a3a;
      color: #f59e0b;
    }
    .view-toggle-button:hover {
      background: #4a4a4a;
      color: #fbbf24;
    }
    .view-toggle-button.active {
      background: #f59e0b;
      color: #1a1a1a;
    }
    #stats {
      font-size: 12px;
      color: #909090;
      white-space: nowrap;
      min-width: 200px;
    }
    /* Popup styling - different for single marker vs cluster */
    .leaflet-popup-content-wrapper {
      width: auto !important;
      max-width: none !important;
    }
    .leaflet-popup-content {
      margin: 12px;
      width: auto !important;
      max-width: none !important;
    }
    /* Single marker popup */
    .leaflet-popup-content:not(:has(.cluster-popup)) {
      max-width: 200px;
    }

    .popup-img {
      max-width: 150px;
      max-height: 150px;
      width: 100%;
      height: auto;
      display: block;
      margin-bottom: 8px;
      cursor: pointer;
      /* Respect EXIF orientation for proper rotation */
      image-orientation: from-image;
      border-radius: 4px;
    }

    .popup-info {
      font-size: 12px;
      color: #e0e0e0;
      word-wrap: break-word;
    }
    .popup-info strong {
      display: block;
      margin-bottom: 3px;
      color: #f59e0b;
      font-size: 13px;
    }

    .popup-loading {
      width: 150px;
      height: 150px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #2a2a2a;
      color: #f59e0b;
      font-size: 12px;
      margin-bottom: 8px;
      border-radius: 4px;
    }

    /* Custom cluster styling */
    .marker-cluster-small, .marker-cluster-medium, .marker-cluster-large {
      background-color: rgba(245, 158, 11, 0.6) !important;
    }
    .marker-cluster-small div, .marker-cluster-medium div, .marker-cluster-large div {
      background-color: #f59e0b !important;
      color: #ffffff !important;
      font-weight: bold;
    }
    .custom-marker {
      background: transparent !important;
      border: none !important;
    }

    /* Cluster popup gallery styling - HORIZONTAL layout with scroll */
    .cluster-popup {
      display: block;
      min-width: 300px;
      max-width: calc(100vw - 200px);
    }
    .cluster-popup-header {
      font-size: 15px;
      font-weight: 600;
      color: #f59e0b;
      margin-bottom: 12px;
      padding-bottom: 8px;
      border-bottom: 1px solid #3a3a3a;
      white-space: nowrap;
      text-align: center;
    }
    .cluster-gallery {
      display: flex;
      flex-direction: row;
      flex-wrap: nowrap;
      gap: 12px;
      padding: 8px 0 16px 0;
      overflow-x: auto;
      overflow-y: hidden;
      /* Custom scrollbar */
      scrollbar-width: thin;
      scrollbar-color: #f59e0b #2a2a2a;
    }
    .cluster-gallery::-webkit-scrollbar {
      height: 10px;
    }
    .cluster-gallery::-webkit-scrollbar-track {
      background: #2a2a2a;
      border-radius: 5px;
      margin: 0 4px;
    }
    .cluster-gallery::-webkit-scrollbar-thumb {
      background: #f59e0b;
      border-radius: 5px;
    }
    .cluster-gallery::-webkit-scrollbar-thumb:hover {
      background: #fbbf24;
    }
    .cluster-gallery-item {
      position: relative;
      width: 220px;
      height: 220px;
      flex-shrink: 0;
      cursor: pointer;
      border-radius: 8px;
      overflow: hidden;
      background: #2a2a2a;
      transition: transform 0.2s, box-shadow 0.2s;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
    }
    .cluster-gallery-item:hover {
      transform: scale(1.08);
      box-shadow: 0 8px 20px rgba(245, 158, 11, 0.6);
      z-index: 10;
    }
    .cluster-gallery-item img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      image-orientation: from-image;
    }
    .cluster-gallery-item-loading {
      display: flex;
      align-items: center;
      justify-content: center;
      color: #707070;
      font-size: 12px;
      width: 100%;
      height: 100%;
    }

  </style>
</head>
<body>
  <div id="map"></div>
  <div id="controls">
    <div class="controls-inner">
      <div class="slider-wrapper">
        <div class="slider-container">
          <label for="timeSlider">Date:</label>
          <div class="slider-track">
            <input type="range" id="timeSlider" min="0" max="100" step="1" value="0">
          </div>
          <span class="slider-value" id="timeLabel">All</span>
        </div>
        <div class="month-markers" id="monthMarkers"></div>
      </div>
      <div class="checkbox-container">
        <input type="checkbox" id="showAllCheckbox" checked>
        <label for="showAllCheckbox">Show all</label>
      </div>
      <button class="view-toggle-button" id="viewToggle">🔥 Heatmap</button>
      <button class="random-button" id="randomButton">Random</button>
      <div id="stats">Loading...</div>
    </div>
  </div>

  <!-- jQuery (required for Lightbox) -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <!-- MarkerCluster JS -->
  <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>
  <!-- Leaflet.heat JS -->
  <script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>
  <!-- Lightbox JS -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lightbox2/2.11.4/js/lightbox.min.js"></script>


  <script>
    // Parse URL parameters for sharing
    function getURLParams() {
      var params = new URLSearchParams(window.location.search);
      return {
        lat: parseFloat(params.get('lat')) || 51.02,
        lng: parseFloat(params.get('lng')) || 13.79,
        zoom: parseInt(params.get('zoom')) || 12,
        month: params.get('month') || null,
        view: params.get('view') || 'markers'  // 'markers' or 'heatmap'
      };
    }

    // Update URL without reloading page
    function updateURL() {
      var center = map.getCenter();
      var zoom = map.getZoom();
      var params = new URLSearchParams();

      params.set('lat', center.lat.toFixed(6));
      params.set('lng', center.lng.toFixed(6));
      params.set('zoom', zoom);

      if (!showAllCheckbox.checked && timePoints.length > 0) {
        var sliderValue = parseInt(timeSlider.value);
        params.set('month', timePoints[sliderValue].yearMonth);
      }

      if (isHeatmapView) {
        params.set('view', 'heatmap');
      }

      var newURL = window.location.pathname + '?' + params.toString();
      window.history.replaceState({}, '', newURL);
    }

    var urlParams = getURLParams();

    // Use Canvas renderer for better performance with many markers
    var map = L.map('map', {
      preferCanvas: true,
      renderer: L.canvas(),
      maxZoom: 18  // Limit maximum zoom level (default is 19)
    }).setView([urlParams.lat, urlParams.lng], urlParams.zoom);

    // Basemap
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    // Custom marker icon
    var customIcon = L.divIcon({
      className: 'custom-marker',
      html: '<div style="background: #f59e0b; width: 12px; height: 12px; border-radius: 50%; border: 2px solid #fff; box-shadow: 0 2px 4px rgba(0,0,0,0.3);"></div>',
      iconSize: [16, 16],
      iconAnchor: [8, 8],
      popupAnchor: [0, -8]
    });

    // Global variables
    var allMarkers = [];
    var allPhotos = []; // Store photo data for heatmap
    var timePoints = []; // sorted array of {yearMonth: "YYYY-MM", label: "MMM YYYY"}
    var monthLayerGroups = {}; // "YYYY-MM" -> cluster group
    var heatLayer = null; // Heatmap layer
    var isHeatmapView = false; // Current view mode
    var selectedMonths = new Set(); // Track selected months for multi-selection

    // UI Elements
    var timeSlider = document.getElementById('timeSlider');
    var timeLabel = document.getElementById('timeLabel');
    var showAllCheckbox = document.getElementById('showAllCheckbox');
    var statsDiv = document.getElementById('stats');
    var monthMarkersDiv = document.getElementById('monthMarkers');
    var randomButton = document.getElementById('randomButton');
    var viewToggleButton = document.getElementById('viewToggle');

    // Ensure checkbox starts as checked (default state)
    showAllCheckbox.checked = true;

    // Parse year-month from datetime string
    function getYearMonth(datetime) {
      if (!datetime) return null;
      var match = datetime.match(/^(\d{4}):(\d{2})/);
      return match ? match[1] + '-' + match[2] : null;
    }

    // Format year-month for display
    function formatYearMonth(yearMonth) {
      var parts = yearMonth.split('-');
      var months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
      return months[parseInt(parts[1]) - 1] + ' ' + parts[0];
    }

    // Debounce function for performance
    var updateTimeout;
    function debounceUpdate() {
      clearTimeout(updateTimeout);
      updateTimeout = setTimeout(updateMap, 50);
    }

    // Update month markers and year selection based on slider
    function updateMonthMarkers() {
      if (timePoints.length === 0) return;

      // Don't update if "Show all" is checked
      if (showAllCheckbox.checked) return;

      var sliderValue = parseInt(timeSlider.value);
      var selectedTimePoint = timePoints[sliderValue];

      if (!selectedTimePoint) return;

      var selectedYear = selectedTimePoint.yearMonth.split('-')[0];

      // Update year marker highlighting
      var yearMarkers = monthMarkersDiv.querySelectorAll('.year-marker');
      yearMarkers.forEach(function(marker) {
        if (marker.dataset.year === selectedYear) {
          marker.classList.add('expanded');

          // Auto-expand this year if not already expanded
          if (window.currentExpandedYear !== selectedYear) {
            marker.click();
          }
        } else {
          // Don't remove expanded class, let user control year expansion
        }
      });

      // Update month marker highlighting
      var monthMarkers = monthMarkersDiv.querySelectorAll('.month-marker');
      monthMarkers.forEach(function(marker) {
        if (parseInt(marker.dataset.index) === sliderValue) {
          marker.classList.add('active');
        } else {
          marker.classList.remove('active');
        }
      });
    }

    // Update map based on slider
    function updateMap() {
      if (isHeatmapView) {
        updateHeatmap();
      } else {
        updateMarkers();
      }
    }

    // Update marker view
    function updateMarkers() {
      var showAll = showAllCheckbox.checked;
      var sliderValue = parseInt(timeSlider.value);

      // Update month markers
      updateMonthMarkers();

      // Clear all layers first (including heatmap)
      if (heatLayer) {
        map.removeLayer(heatLayer);
      }
      Object.values(monthLayerGroups).forEach(function(layerGroup) {
        map.removeLayer(layerGroup);
      });

      // Show all mode
      if (showAll) {
        timeLabel.textContent = 'All';
        var visibleCount = 0;
        Object.values(monthLayerGroups).forEach(function(layerGroup) {
          map.addLayer(layerGroup);
          visibleCount += layerGroup.getLayers().length;
        });
        statsDiv.textContent = 'Showing all ' + allMarkers.length.toLocaleString() + ' photos';
        timeSlider.disabled = true;
        monthMarkersDiv.style.opacity = '0.4';
        return;
      }

      // Enable slider
      timeSlider.disabled = false;
      monthMarkersDiv.style.opacity = '1';

      // Show selected months (multi-selection mode)
      if (selectedMonths.size > 0) {
        var visibleCount = 0;
        var monthLabels = [];

        selectedMonths.forEach(function(yearMonth) {
          var layerGroup = monthLayerGroups[yearMonth];
          if (layerGroup) {
            map.addLayer(layerGroup);
            visibleCount += layerGroup.getLayers().length;
            var tp = timePoints.find(function(t) { return t.yearMonth === yearMonth; });
            if (tp) monthLabels.push(tp.label);
          }
        });

        if (monthLabels.length <= 3) {
          timeLabel.textContent = monthLabels.join(', ');
        } else {
          timeLabel.textContent = monthLabels.length + ' months selected';
        }

        statsDiv.textContent = 'Showing ' + visibleCount.toLocaleString() + ' of ' +
                               allMarkers.length.toLocaleString() + ' photos';
      } else {
        // Fallback to single month from slider
        var selectedIndex = sliderValue;
        var selectedYearMonth = timePoints[selectedIndex].yearMonth;
        timeLabel.textContent = timePoints[selectedIndex].label;

        var layerGroup = monthLayerGroups[selectedYearMonth];
        map.addLayer(layerGroup);
        var visibleCount = layerGroup.getLayers().length;

        statsDiv.textContent = 'Showing ' + visibleCount.toLocaleString() + ' of ' +
                               allMarkers.length.toLocaleString() + ' photos';
      }
    }

    // Update heatmap view
    function updateHeatmap() {
      var showAll = showAllCheckbox.checked;
      var sliderValue = parseInt(timeSlider.value);

      // Update month markers
      updateMonthMarkers();

      // Clear all layers first
      Object.values(monthLayerGroups).forEach(function(layerGroup) {
        map.removeLayer(layerGroup);
      });
      if (heatLayer) {
        map.removeLayer(heatLayer);
      }

      var photosToShow = [];

      // Show all mode
      if (showAll) {
        timeLabel.textContent = 'All';
        photosToShow = allPhotos;
        timeSlider.disabled = true;
        monthMarkersDiv.style.opacity = '0.4';
      } else {
        // Enable slider
        timeSlider.disabled = false;
        monthMarkersDiv.style.opacity = '1';

        // Show selected months (multi-selection mode)
        if (selectedMonths.size > 0) {
          var monthLabels = [];

          photosToShow = allPhotos.filter(function(photo) {
            return selectedMonths.has(photo.yearMonth);
          });

          selectedMonths.forEach(function(yearMonth) {
            var tp = timePoints.find(function(t) { return t.yearMonth === yearMonth; });
            if (tp) monthLabels.push(tp.label);
          });

          if (monthLabels.length <= 3) {
            timeLabel.textContent = monthLabels.join(', ');
          } else {
            timeLabel.textContent = monthLabels.length + ' months selected';
          }
        } else {
          // Fallback to single month from slider
          var selectedYearMonth = timePoints[sliderValue].yearMonth;
          timeLabel.textContent = timePoints[sliderValue].label;

          photosToShow = allPhotos.filter(function(photo) {
            return photo.yearMonth === selectedYearMonth;
          });
        }
      }

      // Create heatmap data: [lat, lng, intensity]
      var heatData = photosToShow.map(function(photo) {
        return [photo.lat, photo.lng, 0.3];
      });

      // Create and add heatmap layer
      heatLayer = L.heatLayer(heatData, {
        radius: 25,
        blur: 15,
        maxZoom: 17,
        max: 5.0,
        gradient: {
          0.0: 'blue',
          0.3: 'cyan',
          0.5: 'lime',
          0.7: 'yellow',
          1.0: 'red'
        }
      }).addTo(map);

      statsDiv.textContent = 'Showing ' + photosToShow.length.toLocaleString() + ' of ' +
                             allPhotos.length.toLocaleString() + ' photos (Heatmap)';
    }

    // Toggle between marker and heatmap view
    function toggleView() {
      isHeatmapView = !isHeatmapView;

      if (isHeatmapView) {
        viewToggleButton.textContent = '📍 Markers';
        viewToggleButton.classList.add('active');
        randomButton.disabled = true;
        randomButton.style.opacity = '0.5';
        updateHeatmap();
      } else {
        viewToggleButton.textContent = '🔥 Heatmap';
        viewToggleButton.classList.remove('active');
        randomButton.disabled = false;
        randomButton.style.opacity = '1';
        updateMarkers();
      }
    }

    // GeoJSON laden
    fetch('photos.geojson')
      .then(response => response.json())
      .then(data => {
        var yearMonths = new Set();

        // Group markers by year-month
        data.features.forEach(feature => {
          var coords = feature.geometry && feature.geometry.coordinates;
          if(!coords || coords.length !== 2) return;

          // Extract year-month
          var yearMonth = getYearMonth(feature.properties.datetime);
          if (!yearMonth) return;

          yearMonths.add(yearMonth);

          // Store photo data for heatmap
          allPhotos.push({
            lat: coords[1],
            lng: coords[0],
            yearMonth: yearMonth
          });

          // Create cluster group for this month if it doesn't exist
          if (!monthLayerGroups[yearMonth]) {
            var clusterGroup = L.markerClusterGroup({
              // Aggressive clustering for MANY markers at same location
              maxClusterRadius: 150,       // Very aggressive clustering
              spiderfyOnMaxZoom: false,    // Disable spiderfy - we use gallery popup instead
              showCoverageOnHover: false,
              zoomToBoundsOnClick: false,  // Don't zoom - show gallery instead
              spiderfyDistanceMultiplier: 1.2,
              // Performance optimizations for MANY markers
              removeOutsideVisibleBounds: true,
              animate: false,              // Disable animations for better performance
              animateAddingMarkers: false,
              chunkedLoading: true,
              chunkInterval: 100,
              chunkDelay: 20,
              disableClusteringAtZoom: null, // NEVER disable clustering (always cluster)
              singleMarkerMode: false      // Always show clusters, never individual markers
            });

            // Custom cluster click handler - show gallery popup
            clusterGroup.on('clusterclick', function(e) {
              var cluster = e.layer;
              var markers = cluster.getAllChildMarkers();

              // Create gallery HTML
              var galleryHtml = '<div class="cluster-popup">' +
                '<div class="cluster-popup-header">📸 ' + markers.length + ' photo' + (markers.length > 1 ? 's' : '') + ' at this location</div>' +
                '<div class="cluster-gallery">';

              markers.forEach(function(marker, index) {
                galleryHtml += '<div class="cluster-gallery-item" data-marker-index="' + index + '">' +
                  '<div class="cluster-gallery-item-loading">...</div>' +
                  '</div>';
              });

              galleryHtml += '</div></div>';

              // Create popup at cluster location
              var popup = L.popup({
                maxWidth: 2000,
                minWidth: 300,
                autoPan: true,
                autoPanPadding: [50, 50],
                className: 'cluster-popup-wrapper'
              })
              .setLatLng(cluster.getLatLng())
              .setContent(galleryHtml)
              .openOn(map);

              // Load images after popup opens
              setTimeout(function() {
                var galleryItems = document.querySelectorAll('.cluster-gallery-item');
                markers.forEach(function(marker, index) {
                  if (marker.thumbPath && galleryItems[index]) {
                    var img = document.createElement('img');
                    img.src = marker.thumbPath;
                    img.alt = marker.filename;
                    img.title = marker.filename + '\n' + marker.datetime;

                    // Click handler to open in lightbox
                    galleryItems[index].addEventListener('click', function() {
                      // Create links for ALL images in proper order for lightbox gallery
                      var tempLinks = [];

                      // Add all markers in order, starting with clicked one
                      markers.forEach(function(m, i) {
                        var link = document.createElement('a');
                        link.href = m.originalPath;
                        link.setAttribute('data-lightbox', 'cluster-gallery-' + Date.now()); // Unique gallery ID
                        link.setAttribute('data-title', m.filename + ' - ' + m.datetime);
                        link.style.display = 'none';
                        document.body.appendChild(link);
                        tempLinks.push(link);
                      });

                      // Click the selected image's link to open lightbox
                      tempLinks[index].click();

                      // Clean up temporary links after lightbox opens
                      setTimeout(function() {
                        tempLinks.forEach(function(link) {
                          if (link.parentNode) {
                            document.body.removeChild(link);
                          }
                        });
                      }, 500);
                    });

                    galleryItems[index].innerHTML = '';
                    galleryItems[index].appendChild(img);
                  }
                });
              }, 50);
            });

            monthLayerGroups[yearMonth] = clusterGroup;
          }

          // Marker erstellen with custom icon
          var marker = L.marker([coords[1], coords[0]], { icon: customIcon });

          // Store paths - use thumbnails for popup, full size for lightbox
          marker.thumbPath = feature.properties.thumb;  // Thumbnails for popup preview
          marker.originalPath = feature.properties.original || feature.properties.thumb;  // Full quality for lightbox
          marker.filename = feature.properties.filename;
          marker.datetime = feature.properties.datetime;

          // Create popup WITHOUT image initially (loads on demand)
          marker.bindPopup(
            "<div class='popup-loading'>Loading image...</div>" +
            "<div class='popup-info'><strong>" + feature.properties.filename + "</strong>" +
            feature.properties.datetime + "</div>",
            { maxWidth: 550, minWidth: 300 }
          );

          // Load image ONLY when popup opens
          marker.on('popupopen', function(e) {
            var popup = e.popup;
            var popupContent = popup.getElement();

            // Check if image already loaded
            if (popupContent.querySelector('.popup-img')) return;

            // Create image element - use THUMBNAIL for popup, but link to full size for lightbox
            if (this.thumbPath) {
              var imgHtml = "<a href='" + this.originalPath + "' data-lightbox='gallery' data-title='" +
                           this.filename + " - " + this.datetime + "'>" +
                           "<img class='popup-img' src='" + this.thumbPath + "' loading='eager'>" +
                           "</a>";

              // Replace loading message with image
              var loadingDiv = popupContent.querySelector('.popup-loading');
              if (loadingDiv) {
                loadingDiv.outerHTML = imgHtml;
              }
            }
          });

          // Add to month-specific cluster group
          monthLayerGroups[yearMonth].addLayer(marker);
          allMarkers.push(marker);
        });

        // Create sorted time points array
        timePoints = Array.from(yearMonths).sort().map(function(ym) {
          return { yearMonth: ym, label: formatYearMonth(ym) };
        });

        // Set slider range: 0 to N-1 for each month
        timeSlider.min = 0;
        timeSlider.max = timePoints.length - 1;
        timeSlider.value = 0;

        // Create year/month hierarchical structure
        var yearGroups = {};
        timePoints.forEach(function(tp, index) {
          var year = tp.yearMonth.split('-')[0];
          if (!yearGroups[year]) {
            yearGroups[year] = [];
          }
          yearGroups[year].push({ label: tp.label, index: index, yearMonth: tp.yearMonth });
        });

        // Create years row (all years on one line)
        var yearsRow = document.createElement('div');
        yearsRow.className = 'years-row';

        // Create months container (below years, shared for all)
        var monthsRow = document.createElement('div');
        monthsRow.className = 'months-row hidden';

        // Global variable to track expanded year (needs to be accessible by updateMonthMarkers)
        window.currentExpandedYear = null;
        var currentExpandedYear = null;

        // Create year markers
        Object.keys(yearGroups).sort().forEach(function(year) {
          var yearMarker = document.createElement('span');
          yearMarker.className = 'year-marker';
          yearMarker.textContent = year;
          yearMarker.dataset.year = year;

          yearMarker.addEventListener('click', function() {
            var year = this.dataset.year;

            // If clicking the same year, collapse it
            if (currentExpandedYear === year) {
              monthsRow.classList.add('hidden');
              this.classList.remove('expanded');
              currentExpandedYear = null;
              window.currentExpandedYear = null;
              return;
            }

            // Uncheck "Show all" when selecting a year
            if (showAllCheckbox.checked) {
              showAllCheckbox.checked = false;
            }

            // Clear all year markers
            yearsRow.querySelectorAll('.year-marker').forEach(function(marker) {
              marker.classList.remove('expanded');
            });

            // Expand this year
            this.classList.add('expanded');
            currentExpandedYear = year;
            window.currentExpandedYear = year;

            // Clear and populate months
            monthsRow.innerHTML = '';
            var firstMonthIndex = null;
            yearGroups[year].forEach(function(month, idx) {
              if (idx === 0) firstMonthIndex = month.index;

              var monthMarker = document.createElement('span');
              monthMarker.className = 'month-marker';
              monthMarker.textContent = month.label;
              monthMarker.dataset.index = month.index;
              monthMarker.dataset.yearMonth = month.yearMonth;

              monthMarker.addEventListener('click', function(e) {
                if (showAllCheckbox.checked) return;

                var yearMonth = this.dataset.yearMonth;

                // Multi-selection with Ctrl/Cmd key only
                if (e.ctrlKey || e.metaKey) {
                  // Toggle selection
                  if (selectedMonths.has(yearMonth)) {
                    selectedMonths.delete(yearMonth);
                    this.classList.remove('selected');
                  } else {
                    selectedMonths.add(yearMonth);
                    this.classList.add('selected');
                  }
                } else {
                  // Normal click without Ctrl - clear selection and use slider mode
                  selectedMonths.clear();
                  monthsRow.querySelectorAll('.month-marker').forEach(function(m) {
                    m.classList.remove('selected');
                  });
                  timeSlider.value = this.dataset.index;
                }

                updateMap();
                updateURL();
              });

              monthsRow.appendChild(monthMarker);
            });

            monthsRow.classList.remove('hidden');

            // Auto-select first month of this year
            if (firstMonthIndex !== null) {
              timeSlider.value = firstMonthIndex;
              updateMap();
              updateURL();
            }
          });

          yearsRow.appendChild(yearMarker);
        });

        monthMarkersDiv.appendChild(yearsRow);
        monthMarkersDiv.appendChild(monthsRow);

        // Ensure initial state is correct
        // Default: show all is checked, no years/months selected
        if (!urlParams.month) {
          showAllCheckbox.checked = true;
          monthsRow.classList.add('hidden');
          yearsRow.querySelectorAll('.year-marker').forEach(function(marker) {
            marker.classList.remove('expanded');
          });
          window.currentExpandedYear = null;
        } else {
          // If month parameter exists, uncheck "show all" and select that month
          showAllCheckbox.checked = false;

          var monthIndex = timePoints.findIndex(function(tp) {
            return tp.yearMonth === urlParams.month;
          });
          if (monthIndex !== -1) {
            timeSlider.value = monthIndex;

            // Expand the year for this month
            var year = urlParams.month.split('-')[0];
            var yearMarker = yearsRow.querySelector('.year-marker[data-year="' + year + '"]');
            if (yearMarker) {
              // Temporarily disable the year click to prevent double update
              setTimeout(function() {
                yearMarker.click();
              }, 10);
            }
          }
        }

        // Apply view mode from URL
        if (urlParams.view === 'heatmap') {
          toggleView();
        }

        // Initial map update
        updateMap();

        // Update URL when map moves or zooms
        map.on('moveend', updateURL);
        map.on('zoomend', updateURL);

        // Event listeners
        timeSlider.addEventListener('input', function() {
          debounceUpdate();
          updateURL();
        });
        showAllCheckbox.addEventListener('change', function() {
          // When show all is checked, collapse months and remove year highlighting
          if (showAllCheckbox.checked) {
            monthsRow.classList.add('hidden');
            yearsRow.querySelectorAll('.year-marker').forEach(function(marker) {
              marker.classList.remove('expanded');
            });
            window.currentExpandedYear = null;
            // Clear multi-selection
            selectedMonths.clear();
            monthsRow.querySelectorAll('.month-marker').forEach(function(m) {
              m.classList.remove('selected');
            });
          }
          updateMap();
          updateURL();
        });

        // View toggle button
        viewToggleButton.addEventListener('click', function() {
          toggleView();
          updateURL();
        });

        // Random button click handler - jump to random visible marker
        randomButton.addEventListener('click', function() {
          if (allMarkers.length === 0) return;

          // Get currently visible markers
          var visibleMarkers = [];
          for (var yearMonth in monthLayerGroups) {
            if (map.hasLayer(monthLayerGroups[yearMonth])) {
              monthLayerGroups[yearMonth].eachLayer(function(layer) {
                if (layer instanceof L.Marker) {
                  visibleMarkers.push(layer);
                }
              });
            }
          }

          if (visibleMarkers.length === 0) {
            visibleMarkers = allMarkers; // Fallback to all markers
          }

          // Get random marker from visible markers
          var randomIndex = Math.floor(Math.random() * visibleMarkers.length);
          var randomMarker = visibleMarkers[randomIndex];

          // Get marker's coordinates
          var latlng = randomMarker.getLatLng();

          // Jump to marker at full zoom (18) without opening
          map.setView(latlng, 18);
        });
      })
      .catch(err => {
        console.error("Fehler beim Laden der GeoJSON:", err);
        statsDiv.textContent = 'Error loading data';
      });
  </script>
</body>
</html>
